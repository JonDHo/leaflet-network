
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Network</title>

	<!--leaflet v0.7.7-->
	<!--<link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css"	/>-->
	<!--<script src="node_modules/leaflet/dist/leaflet.js"></script>-->

	<!--leaflet v1.1.0-->
	<link rel="stylesheet" href="js/leaflet-v1.1.0/leaflet.css"	/>
	<script src="js/leaflet-v1.1.0/leaflet.js"></script>

	<script src="js/d3.v3.min.js"></script>
	<script src="node_modules/underscore/underscore-min.js"></script>
	<script src="test.js"></script>
	<script src="node_modules/jquery/dist/jquery.min.js"></script>

</head>
<body>

<div id="controls">
	Source (show the sites source connections - it feeds): <input class="mode-ctrl" type="radio" name="mode" value="SOURCE"><br/>
	Sink (show the sites sink connections - it consumes): <input class="mode-ctrl" type="radio" name="mode" value="SINK"><br/>
	Both/Bidirectional: <input class="mode-ctrl" type="radio" name="mode" value="BOTH"><br/>
	Any: <input class="mode-ctrl" type="radio" name="mode" value="ANY" checked>
</div>
<div id="map" style="width: 100%; height: 800px"></div>

<script type="text/javascript">

	var map = L.map('map').setView([-42, -73], 9);
	var mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
	L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
		subdomains: 'abcd',
		maxZoom: 19
	}).addTo(map);

	// the target/currently inspected site ID, and mode of inspection
	var targetId = null;
	var visMode = 'ANY';

	// TODO
	// scale matrix values to a consistent range, this needs work
	linearScale = d3.scale.linear().domain([0,2000]).range([1,5]);

	// initialize the SVG layer
	// TODO refactor to leaflet v1
	var svgLayer = L.svg();
	svgLayer.addTo(map);

	/*
	e.g. for v1
	 "When an SVG element is created, it automatically has a 'g' group added"

	 var svgLayer = L.svg();
	 svgLayer.addTo(map);

	 var svg = d3.select("#map").select("svg");
	 var g = d3.select("#map").select("svg").select('g');
	 g.attr("class", "leaflet-zoom-hide");
	 */

//	map._initPathRoot();

	// we simply pick up the SVG from the map object
	var svg = d3.select("#map").select("svg");
	var group1 = svg.append("g");
	var group2 = group1.append("g");


	// add a leaflet position to each site
	var siteIds = _.keys(data);
	_.each(siteIds, function(id){
		data[id]['id'] = id;
		data[id].LatLng = new L.LatLng(data[id].lat, data[id].lon);
	});

	// create site circles
	var feature = group1.selectAll("circle")
		.data(_.map(data, function(d){ return d; }))
		.attr("class", "site")
		.enter().append("circle")
		.style("opacity", .5)
		.style("cursor", "pointer")
		.style("fill", "red")
		.attr("r", 5)
		.on('click', function(d){

			console.log(d);

			// set circles all inactive style, set this active
			group1.selectAll("circle").style("opacity", 0.5).attr("r", 5);
			d3.select(this).style({opacity:'0.8'}).attr("r", 10);

			// redraws ALL lines
			// TODO can probably do this more efficiently, e.g. just update style
			targetId = d.id;
			drawConnections(targetId);
		});


	function update() {
		console.log('update');
		drawConnections(targetId);
		feature.attr("transform",
			function(d) {
				return "translate("+
					map.latLngToLayerPoint(d.LatLng).x +","+
					map.latLngToLayerPoint(d.LatLng).y +")";
			}
		);
	}


	var mode = 'BOTH'; // || SINK || ALL

	function drawConnections(target){

		group2.selectAll(".connection").remove();

		_.each(siteIds, function(id){

			var site = data[id];
			var targetPoint = map.latLngToLayerPoint(site.LatLng);
			var conKeys = _.keys(site.connections);

			_.each(conKeys, function(conKey){

				var conSite = data[conKey];
				if(!conSite || !site.connections[conKey]) return;
				var conPoint = map.latLngToLayerPoint(conSite.LatLng);

				var conValue = site.connections[conKey];
				var val = parseInt(linearScale(conValue));

				var color = 'grey';
				var opacity = 0.2;

				if(target){

					if(visMode == 'SOURCE' && target == id){
						color = 'red';
						opacity = 0.8;
					}
					else if(visMode == 'SINK' && target == conKey){
						color = 'green';
						opacity = 0.8;
					}
					else if(visMode == 'ANY') {
						if(target == id){
							color = 'red';
							opacity = 0.8;
						}
						if(target == conKey){
							color = 'red';
							opacity = 0.8;
						}
					}
					else if(visMode == 'BOTH') {

						if(target == id){
							color = 'red';
							opacity = 0.8;
						}
						if(target == conKey){
							color = 'green';
							opacity = 0.8;
						}

					}

				}


				var line = group2.append("line")
					.attr("class", "connection")
					.attr("x1", targetPoint.x)
					.attr("y1", targetPoint.y)
					.attr("x2", conPoint.x)
					.attr("y2", conPoint.y)
					.attr("stroke-width", val)
					.attr("stroke-opacity", opacity)
					.attr("stroke", color);

			});
		});

	};

	map.on("moveend", update);
//	map.on("viewreset", update);
	update();

	$(document).ready(function(){

		$('input[type=radio][name=mode]').change(function() {
			console.log(this.value);
			visMode = this.value;
			drawConnections(targetId);
		});
	});

</script>
</body>
</html>
