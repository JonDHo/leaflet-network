"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"SOURCE",globalWeightMode:!0,localColorScale:["green","red"],scaleDomain:null,lineWidthRange:[1,5],onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_active:!1,_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearWidthScale:null,_localColors:[],initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=this,o=this;this._active=!0;var n=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null;var i;i=this.options.scaleDomain?this.options.scaleDomain:this._getConnectionsDomain(n),this.options.localColorScale.forEach(function(t){e._localColors.push(d3.rgb(t))}),this._linearWidthScale=d3.scaleLinear().domain(i).range(this.options.lineWidthRange),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var a=d3.select("#"+t.getContainer().id).select("svg");a.attr("pointer-events","all"),this._svgGroup1=a.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",.5).style("cursor","pointer").style("fill","red").attr("r",5).on("click",function(t){console.log(t),o._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),d3.select(this).style("opacity","0.8").attr("r",10),o._targetId=t.properties.id,o._drawConnections(o._targetId)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._active=!1,this._mapSvg.removeFrom(t)},update:function(){var t=this;t._drawConnections(this._targetId),this._targetId||t._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),this._svgGroup1.selectAll("circle").attr("transform",function(e){return"translate("+t._map.latLngToLayerPoint(e.properties.LatLng).x+","+t._map.latLngToLayerPoint(e.properties.LatLng).y+")"})},setData:function(t){this.options.data=t,this._active&&this.update()},setTarget:function(t){this._targetId=t,this._active&&this.update()},setDisplayMode:function(t){this.options.displayMode=t,this._active&&this.update()},getPointById:function(t){for(var e=this.options.data,o=0;o<e.length;o++)if(t==e[o].properties.id)return e[o]},isActive:function(){return this._active},_getConnectionsDomain:function(t){var e=[];t.forEach(function(t){e=e.concat(Object.values(t.connections))});var o=d3.min(e),n=d3.max(e);return[o,n]},_drawConnections:function(t){var e=this,o=this._map,n=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove();var a=[],r=[];if(n.forEach(function(n){var s=Object.keys(n.connections);s.forEach(function(s){var l=e.getPointById(s);if(l&&n.connections[s]){var c="grey",p=.2,d=n.connections[s];if(t&&!e.options.globalWeightMode){if(t===n.properties.id){var u={properties:n.properties,connections:{}};return u.connections[s]=n.connections[s],void a.push(u)}if(t===s){var h={properties:n.properties,connections:{}};return h.connections[s]=n.connections[s],void r.push(h)}}else t&&e.options.globalWeightMode&&("SOURCE"==e.options.displayMode&&t==n.properties.id?(c="red",p=.8):"SINK"==e.options.displayMode&&t==s?(c="green",p=.8):"ANY"==e.options.displayMode?(t==n.properties.id&&(c="red",p=.8),t==s&&(c="red",p=.8)):"BOTH"==e.options.displayMode&&(t==n.properties.id&&(c="red",p=.8),t==s&&(c="green",p=.8)));var g=o.latLngToLayerPoint(n.properties.LatLng),v=o.latLngToLayerPoint(l.properties.LatLng),L=parseInt(e._linearWidthScale(d));i.append("line").attr("class","connection").attr("x1",g.x).attr("y1",g.y).attr("x2",v.x).attr("y2",v.y).attr("stroke-width",L).attr("stroke-opacity",p).attr("stroke",c)}})}),"BOTH"===e.options.displayMode){var s=this._getConnectionsDomain(r),l=d3.scaleLinear().domain(s).interpolate(d3.interpolateHcl).range(e._localColors);this._drawLocalWeightedNodes(r,l,i,"10, 3");var c=this._getConnectionsDomain(a),p=d3.scaleLinear().domain(c).interpolate(d3.interpolateHcl).range(e._localColors);this._drawLocalWeightedNodes(a,p,i,null)}else{var d;switch(e.options.displayMode){case"SINK":d=r;break;case"SOURCE":d=a;break;case"ANY":d=r.concat(a);break;default:console.error("Invalid displayMode")}var u=this._getConnectionsDomain(d),h=d3.scaleLinear().domain(u).interpolate(d3.interpolateHcl).range(e._localColors);this._drawLocalWeightedNodes(d,h,i,null)}},_drawLocalWeightedNodes:function(t,e,o,n){var i=this;t.forEach(function(t){var a=Object.keys(t.connections);a.forEach(function(a){var r=i.getPointById(a);if(r&&t.connections[a]){var s=t.connections[a],l=i._map.latLngToLayerPoint(t.properties.LatLng),c=i._map.latLngToLayerPoint(r.properties.LatLng);o.append("line").attr("class","connection").attr("x1",l.x).attr("y1",l.y).attr("x2",c.x).attr("y2",c.y).attr("stroke-width",2).attr("stroke-opacity",.9).attr("stroke",e(s)).attr("data-weight",s).style("cursor","pointer").style("stroke-dasharray",n).on("mouseenter",i.options.onMouseEnterLine).on("mouseleave",i.options.onMouseLeaveLine)}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};