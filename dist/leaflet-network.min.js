"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"SOURCE"},_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=this,n=this.options.data;this._targetId=null,this._linearScale=d3.scale.linear().domain([0,100]).range([1,5]),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var o=d3.select("#map").select("svg");o.attr("pointer-events","all"),this._svgGroup1=o.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",.5).style("cursor","pointer").style("fill","red").attr("r",5).on("click",function(t){console.log(t),e._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),d3.select(this).style({opacity:"0.8"}).attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId)}),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._mapSvg.removeFrom(t)},update:function(){console.log("update");var t=this;t._drawConnections(this._targetId),this._svgGroup1.selectAll("circle").attr("transform",function(e){return"translate("+t._map.latLngToLayerPoint(e.properties.LatLng).x+","+t._map.latLngToLayerPoint(e.properties.LatLng).y+")"})},getPointById:function(t){for(var e=this.options.data,n=0;n<e.length;n++)if(t==e[n].properties.id)return e[n]},setDisplayMode:function(t){this.options.displayMode=t,this.update()},setTarget:function(t){this._targetId=t,this.update()},setData:function(t){this.options.data=t,this.update()},_drawConnections:function(t){var e=this,n=this._map,o=this.options.data,r=this._svgGroup2;r.selectAll(".connection").remove(),o.forEach(function(o){var i=n.latLngToLayerPoint(o.properties.LatLng),a=Object.keys(o.connections);a.forEach(function(a){var s=e.getPointById(a);if(s&&o.connections[a]){var p=n.latLngToLayerPoint(s.properties.LatLng),l=o.connections[a],c=parseInt(e._linearScale(l)),d="grey",u=.2;t&&("SOURCE"==e.options.displayMode&&t==o.properties.id?(d="red",u=.8):"SINK"==e.options.displayMode&&t==a?(d="green",u=.8):"ANY"==e.options.displayMode?(t==o.properties.id&&(d="red",u=.8),t==a&&(d="red",u=.8)):"BOTH"==e.options.displayMode&&(t==o.properties.id&&(d="red",u=.8),t==a&&(d="green",u=.8))),r.append("line").attr("class","connection").attr("x1",i.x).attr("y1",i.y).attr("x2",p.x).attr("y2",p.y).attr("stroke-width",c).attr("stroke-opacity",u).attr("stroke",d)}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};