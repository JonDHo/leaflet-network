"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"SOURCE",scaleDomain:null,scaleRange:[1,100],onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=this;console.log("this.options"),console.log(this.options);var o=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null;var n;if(this.options.scaleDomain)console.log("use provided domain option"),n=this.options.scaleDomain;else{var i=[];o.forEach(function(t){i=i.concat(Object.values(t.connections))});var s=d3.min(i),a=d3.max(i);console.log("auto calc domain: "+s+" - "+a),n=[s,a]}this._linearScale=d3.scaleLinear().domain(n).range(this.options.scaleRange),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var r=d3.select("#map").select("svg");r.attr("pointer-events","all"),this._svgGroup1=r.append("g"),this._svgGroup2=this._svgGroup1.append("g"),o.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(o.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",.5).style("cursor","pointer").style("fill","red").attr("r",5).on("click",function(t){console.log(t),e._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),d3.select(this).style("opacity","0.8").attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._mapSvg.removeFrom(t)},update:function(){console.log("update");var t=this;t._drawConnections(this._targetId),this._svgGroup1.selectAll("circle").attr("transform",function(e){return"translate("+t._map.latLngToLayerPoint(e.properties.LatLng).x+","+t._map.latLngToLayerPoint(e.properties.LatLng).y+")"})},getPointById:function(t){for(var e=this.options.data,o=0;o<e.length;o++)if(t==e[o].properties.id)return e[o]},setDisplayMode:function(t){this.options.displayMode=t,this.update()},setTarget:function(t){this._targetId=t,this.update()},setData:function(t){this.options.data=t,this.update()},_drawConnections:function(t){var e=this,o=this._map,n=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove(),n.forEach(function(n){var s=o.latLngToLayerPoint(n.properties.LatLng),a=Object.keys(n.connections);a.forEach(function(a){var r=e.getPointById(a);if(r&&n.connections[a]){var l=o.latLngToLayerPoint(r.properties.LatLng),p=n.connections[a],c=parseInt(e._linearScale(p)),d="grey",u=.2;t&&("SOURCE"==e.options.displayMode&&t==n.properties.id?(d="red",u=.8):"SINK"==e.options.displayMode&&t==a?(d="green",u=.8):"ANY"==e.options.displayMode?(t==n.properties.id&&(d="red",u=.8),t==a&&(d="red",u=.8)):"BOTH"==e.options.displayMode&&(t==n.properties.id&&(d="red",u=.8),t==a&&(d="green",u=.8))),i.append("line").attr("class","connection").attr("x1",s.x).attr("y1",s.y).attr("x2",l.x).attr("y2",l.y).attr("stroke-width",c).attr("stroke-opacity",u).attr("stroke",d)}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};