"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"SOURCE"},_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=this,n=this.options.data;this._targetId=null,this._linearScale=d3.scale.linear().domain([0,100]).range([1,5]),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var r=d3.select("#map").select("svg");r.attr("pointer-events","all"),this._svgGroup1=r.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",.5).style("cursor","pointer").style("fill","red").attr("r",5).on("click",function(t){console.log(t),e._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),d3.select(this).style({opacity:"0.8"}).attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId)}),this._map=t,this._map.on("moveend",this.update,this),this.update()},update:function(){console.log("update");var t=this;t._drawConnections(this._targetId),this._svgGroup1.selectAll("circle").attr("transform",function(e){return"translate("+t._map.latLngToLayerPoint(e.properties.LatLng).x+","+t._map.latLngToLayerPoint(e.properties.LatLng).y+")"})},getPointById:function(t){for(var e=this.options.data,n=0;n<e.length;n++)if(t==e[n].properties.id)return e[n]},onRemove:function(t){this._mapSvg.removeFrom(t)},setData:function(t){this.options.data=t,this._drawConnections()},_drawConnections:function(t){var e=this,n=this._map,r=this.options.data,o=this._svgGroup2;o.selectAll(".connection").remove(),r.forEach(function(r){var a=n.latLngToLayerPoint(r.properties.LatLng),i=Object.keys(r.connections);i.forEach(function(i){var s=e.getPointById(i);if(s&&r.connections[i]){var p=n.latLngToLayerPoint(s.properties.LatLng),l=r.connections[i],c=parseInt(e._linearScale(l)),d="grey",g=.2;t&&("SOURCE"==e.options.displayMode&&t==r.properties.id?(d="red",g=.8):"SINK"==e.options.displayMode&&t==i?(d="green",g=.8):"ANY"==e.options.displayMode?(t==r.properties.id&&(d="red",g=.8),t==i&&(d="red",g=.8)):"BOTH"==e.options.displayMode&&(t==r.properties.id&&(d="red",g=.8),t==i&&(d="green",g=.8))),o.append("line").attr("class","connection").attr("x1",a.x).attr("y1",a.y).attr("x2",p.x).attr("y2",p.y).attr("stroke-width",c).attr("stroke-opacity",g).attr("stroke",d)}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};